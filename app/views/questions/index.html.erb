<div class="container">
    <h1>質問一覧</h1>

    <p>
        ログイン中: <%= current_user.handle_name %> (<%= current_user.role %>)
        <%= link_to "ログアウト", logout_path, data: { turbo_method: :delete } %>
    </p>

    <% if current_user.student? %>
        <%= link_to "質問を投稿", new_question_path %>
    <% end %>

    <% @questions.each do |q| %>
        <hr>
        <div class="question-item">
            <h2><%= q.title %> (<%= q.public ? "公開" : "非公開" %>)</h2>
            <p><%= q.content %></p>
            <small>投稿者: <%= q.user.handle_name %></small>

            <%# 質問の編集・削除ボタン %>
            <% if q.user == current_user %>
                <%= link_to "編集", edit_question_path(q) %>
                <%= link_to "削除", question_path(q), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" } %>
            <% end %>

            <%# --- 回答一覧 --- %>
            <div class="answer-box">
                <h4>回答:</h4>
                <% q.answers.each do |a| %>
                    <p><%= a.content %>（<%= a.user.handle_name %>）
                    <%# 回答の編集・削除ボタン %>
                    <% if a.user == current_user %>
                        <%= link_to "編集", edit_question_answer_path(q, a) %>
                        <%= link_to "削除", question_answer_path(q, a), data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" } %>
                    <% end %>
                    </p>
                <% end %>
            </div>

            <%# --- 回答フォーム (権限制御) --- %>
            <%# 講師 || (受講生 && 公開質問) の場合のみ回答可能 %>
            <% if current_user.teacher? || q.public %>
                <%= form_with model: [q, Answer.new] do |f| %>
                    <%= f.text_area :content, placeholder: "回答を入力", required: true %>
                    <%= f.submit "回答する" %>
                <% end %>
            <% end %>
        </div>
    <% end %>
</div>